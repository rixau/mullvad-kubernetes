services:
  # Mullvad VPN Proxy Pool - US Server
  mullvad-proxy-us:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mullvad-proxy-us
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun
    privileged: true
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    environment:
      # Enable proxy pool mode
      - ENABLE_PROXY_MODE=true
      - ENABLE_KILL_SWITCH=false
      - ENABLE_DNS_CONFIG=false
      - ENABLE_BYPASS_ROUTES=true
      - ENABLE_HEALTH_PROBE=true
      # Proxy configuration
      - SOCKS5_PORT=1080
      - HTTP_PORT=3128
      - PROXY_AUTH=false
      # - PROXY_USERNAME=proxy
      # - PROXY_PASSWORD=changeme
      # Metrics configuration
      - METRICS_PORT=9090
      - PROXY_NAME=simple-dog
    volumes:
      - ./conf/simple-dog.conf:/etc/wireguard/wg0.conf:ro
    ports:
      - "10800:1080"   # SOCKS5 (10800 on host to avoid conflicts)
      - "13128:3128"   # HTTP (13128 on host to avoid conflicts)
      - "9998:9999"    # Health probe (9998 to avoid conflicts)
      - "19090:9090"   # Metrics (19090 to avoid conflicts)
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9999 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - proxy-network
      - burban-network


networks:
  proxy-network:
    driver: bridge
  burban-network:
    external: true
