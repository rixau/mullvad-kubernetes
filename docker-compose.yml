services:
  # Mullvad WireGuard sidecar
  mullvad-sidecar:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: mullvad-sidecar
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun
    privileged: true
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    ports:
      - "9999:9999"  # Health probe endpoint
    volumes:
      # Mount your chosen Mullvad config file
      - ./conf/br-sao-wg-001.conf:/etc/wireguard/wg0.conf:ro
    networks:
      - test-network

  # Test application that checks IP to verify VPN
  ip-test-app:
    image: curlimages/curl:latest
    container_name: ip-test-app
    # Share network namespace with VPN sidecar
    network_mode: "container:mullvad-sidecar"
    depends_on:
      - mullvad-sidecar
    command: >
      sh -c "
      echo 'üîç Testing Mullvad VPN functionality...' &&
      echo '‚è≥ Waiting for VPN to be ready...' &&
      sleep 30 &&
      echo 'üåê Checking external IP...' &&
      CURRENT_IP=\$(curl -s --max-time 15 http://httpbin.org/ip | grep -o '\"origin\": \"[^\"]*\"' | cut -d'\"' -f4) &&
      echo \"üìç Current external IP: \$CURRENT_IP\" &&
      if echo \"\$CURRENT_IP\" | grep -qE '^(185\.|194\.|91\.|149\.)'; then
        echo \"‚úÖ MULLVAD VPN WORKING - Using Mullvad IP: \$CURRENT_IP\" &&
        echo \"üéâ SUCCESS: Traffic is routing through Mullvad WireGuard!\"
      else
        echo \"‚ùå VPN NOT WORKING - IP: \$CURRENT_IP\" &&
        echo \"üö® FAILURE: Traffic is not routing through VPN\"
      fi &&
      echo 'üîÑ Continuous monitoring...' &&
      while true; do
        sleep 60
        NEW_IP=\$(curl -s --max-time 10 http://httpbin.org/ip | grep -o '\"origin\": \"[^\"]*\"' | cut -d'\"' -f4)
        echo \"\$(date): External IP: \$NEW_IP\"
      done
      "

  # Simple web server for additional testing
  test-web:
    image: nginx:alpine
    container_name: test-web
    # Share network namespace with VPN sidecar
    network_mode: "container:mullvad-sidecar"
    depends_on:
      - mullvad-sidecar
    ports:
      - "8080:80"  # Access via http://localhost:8080
    volumes:
      - ./test-index.html:/usr/share/nginx/html/index.html:ro

networks:
  test-network:
    driver: bridge
